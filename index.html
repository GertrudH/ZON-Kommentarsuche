<!DOCTYPE html>
<html>
    <head>
        <title>ZON Kommentarsuche</title>
        
        
        <meta charset="UTF-8">
        <meta name="author" content="Gertrud H.">
        <meta name="description" content="Benutzerkommentare auf ZON durchsuchen">
        
        <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1, initial-scale=1">

        <style>
            
        </style>
        <script>


/* CONFIGURATION */

userURL = "http://community.zeit.de/user/{user}";
commentsURL = "http://community.zeit.de/user/{user}?page={page}";

userData = {
    "name" : /<h2 class="title">(.+)<\/h2>/g,
    "pic"  : /<div class="user-picture">[\s|\n]+<img typeof="foaf:Image" src="(.+)" alt="/g,
    "rec"  : /<div class="usr-rec-cmts">[\s|\n]+([\d]+)/g
}
commentsData = /<div class="usr-prf-cmt">([\S\s]*?)<\/div><\/div>/g;
commentData = {
    "url" : /<a href="(http:\/\/.*?)">.*?<\/a>/,
    "title" : /\d+">(.*?)<\/a>/,
    "text" : /<\/a>(<p>[\S\s]*?<\/p>)<div class="timestamp">/,
    "more" : /">(mehr)<\/a><\/p><div class="timestamp">/,
    "date" : /<div class="timestamp">(.*?)$/
}


/* SOME GLOBALS */

var searchform, searchquery, searchuser, searchsubmit;
var userdata, username, userrec, useravatar, userlink;
var list, infos;


/* PROGRAM */

var init = function () {
    searchform = getID("searchform");
    searchquery = getID("searchquery");
    searchuser = getID("searchuser");
    searchsubmit = getID("searchsubmit");
    
    userdata = getID("userdata");
    username = getID("username");
    useravatar = getID("useravatar");
    userlink = getID("userlink");
    userrec = getID("userrec");
    
    list = getID("list");
    infos = getID("infos");
    
    searchsubmit.addEventListener("click", search);
    
    document.addEventListener("keydown", function (e) {
        if (e.keyCode == 13) search();
    });
}

var search = function (e) {
    clear();
    
    var u = searchuser.value;
    var q = searchquery.value;
    
    u = u.toLowerCase();
    u = u.replace(/ /g, "-");
    u = u.replace(/[^0-9a-zA-Z\-]/g, "");
    u = u.replace(/\-+/, "-");
    
    if (!u) {
        info("Bitte gib einen Benutzernamen ein");
        return;
    }
        
    var uurl = userURL.replace("{user}", u);
    
    ajax(uurl, "html", function (r) {
        fetchUser(r, uurl);
        fetchComments(r);
    });
}

var fetchUser = function (res, url) {
    if (!res) {
        info("Benutzer nicht gefunden");
        return;
    }
    var data = exploitData(res, userData);
    username.innerHTML = data.name;
    userrec.innerHTML = data.rec;
    useravatar.style.backgroundImage = "url('" + data.pic + "')";
    userlink.href = url;
}

var fetchComments = function (res) {
    //page = page || 0;
    var cs = exploitMultiple(res, commentsData);
    for (var i = 0; i < cs.length; i++) {
        var c = exploitData(cs[i], commentData);
    }
}

exploitData = function (data, rules) {
    var res = {};
    for (var i in rules) {
        if (!rules.hasOwnProperty(i)) continue;
        var d = rules[i].exec(data);
        if (d)
            res[i] = d[1];
        rules[i].lastIndex = 0;
    }
    return res;
}

exploitMultiple = function (data, rule) {
    var res = [];
    do {
        var a = rule.exec(data);
        if (a) res.push(a[1]);
    } while (a);
    return res;
}

var clear = function () {
    while (list.firstChild) list.removeChild(list.firstChild);
    while (infos.firstChild) infos.removeChild(infos.firstChild);
    
    username.innerHTML = "";
    userrec.innerHTML = "";
    useravatar.style.backgroundImage = "";
    userlink.href = "";
}

var info = function (i) {
    var e = element("li", {}, infos);
    e.innerHTML = i;
}

document.addEventListener("DOMContentLoaded", init);


/* LITTLE HELPERS */

var getID = function (id) {
    return document.getElementById(id);
}

var element = function (type, attrs, parent) {
    var e = document.createElement(type);
    for (var i in attrs) if (attrs.hasOwnProperty(i)) e.setAttribute(i, attrs[i]);
    if (parent) parent.appendChild(e);
    return e;
}

var ajax = function (query, type, callback) {
    var request = new XMLHttpRequest();
    request.onreadystatechange = function () {
        if (request.readyState == 4 && request.status == 200) {
            if (request.responseText) {
                if (type == "js" || type == "json")
                    callback(eval('(' + request.responseText + ')'));
                else
                    callback(request.responseText);
            } else
                callback();
        } else if (request.readyState == 4) {
            callback();
        }
    }
    request.open("GET", query, true);
    request.send();
}


/* LAYOUT */
        </script>
    </head>
    <body>
        
        <div id="searchform">
            <input type="text" id="searchuser" placeholder="Benutzer" value="Gertrud H."></input>
            <label for="searchuser">Benutzername, Benutzer-ID, Benutzer-URL</label>
            <input type="text" id="searchquery" placeholder="Suchbegriff"></input>
            <label for="searchuser">Suchbegriff (Leer f√ºr alle Kommentare)</label>
            <button id="searchsubmit">Suchen</button>
        </div>
        
        <div id="userdata">
            <a href="" id="userlink" target="_blank">
                <div id="useravatar"></div>
                <div id="username"></div>
                <div id="userrec"></div>
            </a>
        </div>
        
        <ul id="infos"></ul>
        
        <ul id="list"></ul>
        
        <div id="help">
